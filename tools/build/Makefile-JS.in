# This is the JS Makefile - autogenerated by gen-js-makefile.nqp
JS_BUILD_DIR = gen/js
JS_STAGE1_DIR = $(JS_BUILD_DIR)/stage1
JS_STAGE2_DIR = $(JS_BUILD_DIR)/stage2
JS_NQP = ./$(M_RUNNER)$(BAT)
js-runner-default: js-all
$(JS_STAGE1_DIR)/QASTCompiler.nqp: src/vm/js/Utils.nqp src/vm/js/SerializeOnce.nqp src/vm/js/const_map.nqp src/vm/js/LoopInfo.nqp src/vm/js/ReturnInfo.nqp src/vm/js/BlockBarrier.nqp src/vm/js/DWIMYNameMangling.nqp src/vm/js/Chunk.nqp src/vm/js/Operations.nqp src/vm/js/RegexCompiler.nqp src/vm/js/Compiler.nqp
	$(MKPATH) $(JS_STAGE1_DIR)
	
	$(PERL) tools/build/gen-cat.pl js src/vm/js/Utils.nqp src/vm/js/SerializeOnce.nqp src/vm/js/const_map.nqp src/vm/js/LoopInfo.nqp src/vm/js/ReturnInfo.nqp src/vm/js/BlockBarrier.nqp src/vm/js/DWIMYNameMangling.nqp src/vm/js/Chunk.nqp src/vm/js/Operations.nqp src/vm/js/RegexCompiler.nqp src/vm/js/Compiler.nqp  > $(JS_STAGE1_DIR)/QASTCompiler.nqp

$(JS_STAGE1_DIR)/QAST/Compiler.moarvm: $(JS_STAGE1_DIR)/QASTCompiler.nqp
	$(MKPATH) $(JS_STAGE1_DIR)/QAST
	$(JS_NQP) --module-path=$(JS_STAGE1_DIR) --target=mbc --output=$(JS_STAGE1_DIR)/QAST/Compiler.moarvm $(JS_STAGE1_DIR)/QASTCompiler.nqp
	$(MKPATH) gen/moar/stage2/QAST
	$(CP) $(JS_STAGE1_DIR)/QAST/Compiler.moarvm gen/moar/stage2/QAST/Compiler.moarvm

$(JS_STAGE1_DIR)/HLL/Backend.moarvm: src/vm/js/HLL/Backend.nqp $(JS_STAGE1_DIR)/QAST/Compiler.moarvm
	$(MKPATH) $(JS_STAGE1_DIR)/HLL
	$(JS_NQP) --module-path=$(JS_STAGE1_DIR) --target=mbc --output=$(JS_STAGE1_DIR)/HLL/Backend.moarvm src/vm/js/HLL/Backend.nqp
	$(MKPATH) gen/moar/stage2/HLL
	$(CP) $(JS_STAGE1_DIR)/HLL/Backend.moarvm gen/moar/stage2/HLL/Backend.moarvm

JS_STAGE1_COMPILER = $(JS_STAGE1_DIR)/QAST/Compiler.moarvm $(JS_STAGE1_DIR)/HLL/Backend.moarvm
$(JS_STAGE2_DIR)/$(NQP_MO_COMBINED): $(NQP_MO_SOURCES)
	$(MKPATH) $(JS_STAGE2_DIR)
	
	$(PERL) tools/build/gen-cat.pl js $(NQP_MO_SOURCES)  > $(JS_STAGE2_DIR)/$(NQP_MO_COMBINED)

$(JS_STAGE2_DIR)/nqpmo.moarvm: $(JS_STAGE1_COMPILER) $(JS_STAGE2_DIR)/$(NQP_MO_COMBINED)
	$(MKPATH) $(JS_STAGE2_DIR)
	$(MKPATH) nqp-js-on-js
	$(JS_NQP) --module-path gen/js/stage1 src/vm/js/bin/cross-compile.nqp --setting=NULL --target=mbc --output $(JS_STAGE2_DIR)/nqpmo.moarvm --no-regex-lib $(JS_STAGE2_DIR)/$(NQP_MO_COMBINED) > nqp-js-on-js/nqpmo.js

$(JS_STAGE2_DIR)/$(CORE_SETTING_COMBINED).nqp: $(CORE_SETTING_SOURCES)
	$(MKPATH) $(JS_STAGE2_DIR)
	
	$(PERL) tools/build/gen-cat.pl js $(CORE_SETTING_SOURCES)  > $(JS_STAGE2_DIR)/$(CORE_SETTING_COMBINED).nqp

$(JS_STAGE2_DIR)/NQPCORE.setting.moarvm: $(JS_STAGE1_COMPILER) $(JS_STAGE2_DIR)/$(CORE_SETTING_COMBINED).nqp $(JS_STAGE2_DIR)/nqpmo.moarvm
	$(MKPATH) $(JS_STAGE2_DIR)
	$(MKPATH) nqp-js-on-js
	$(JS_NQP) --module-path gen/js/stage1 src/vm/js/bin/cross-compile.nqp --setting=NULL --target=mbc --output $(JS_STAGE2_DIR)/NQPCORE.setting.moarvm --no-regex-lib $(JS_STAGE2_DIR)/$(CORE_SETTING_COMBINED).nqp > nqp-js-on-js/NQPCORE.setting.js

$(JS_STAGE2_DIR)/$(QASTNODE_COMBINED): $(QASTNODE_SOURCES)
	$(MKPATH) $(JS_STAGE2_DIR)
	
	$(PERL) tools/build/gen-cat.pl js $(QASTNODE_SOURCES)  > $(JS_STAGE2_DIR)/$(QASTNODE_COMBINED)

$(JS_STAGE2_DIR)/QASTNode.moarvm: $(JS_STAGE1_COMPILER) $(JS_STAGE2_DIR)/$(QASTNODE_COMBINED) $(JS_STAGE2_DIR)/NQPCORE.setting.moarvm
	$(MKPATH) $(JS_STAGE2_DIR)
	$(MKPATH) nqp-js-on-js
	$(JS_NQP) --module-path gen/js/stage1 src/vm/js/bin/cross-compile.nqp --setting=NQPCORE --target=mbc --output $(JS_STAGE2_DIR)/QASTNode.moarvm --no-regex-lib $(JS_STAGE2_DIR)/$(QASTNODE_COMBINED) > nqp-js-on-js/QASTNode.js

$(JS_STAGE2_DIR)/$(QREGEX_COMBINED): $(QREGEX_SOURCES)
	$(MKPATH) $(JS_STAGE2_DIR)
	
	$(PERL) tools/build/gen-cat.pl js $(QREGEX_SOURCES)  > $(JS_STAGE2_DIR)/$(QREGEX_COMBINED)

$(JS_STAGE2_DIR)/QRegex.moarvm: $(JS_STAGE1_COMPILER) $(JS_STAGE2_DIR)/$(QREGEX_COMBINED) $(JS_STAGE2_DIR)/NQPCORE.setting.moarvm $(JS_STAGE2_DIR)/QASTNode.moarvm
	$(MKPATH) $(JS_STAGE2_DIR)
	$(MKPATH) nqp-js-on-js
	$(JS_NQP) --module-path gen/js/stage1 src/vm/js/bin/cross-compile.nqp --setting=NQPCORE --target=mbc --output $(JS_STAGE2_DIR)/QRegex.moarvm --no-regex-lib $(JS_STAGE2_DIR)/$(QREGEX_COMBINED) > nqp-js-on-js/QRegex.js

$(JS_STAGE2_DIR)/sprintf.moarvm: $(JS_STAGE1_COMPILER) src/HLL/sprintf.nqp $(JS_STAGE2_DIR)/NQPCORE.setting.moarvm $(JS_STAGE2_DIR)/QRegex.moarvm
	$(MKPATH) $(JS_STAGE2_DIR)
	$(MKPATH) nqp-js-on-js
	$(JS_NQP) --module-path gen/js/stage1 src/vm/js/bin/cross-compile.nqp --setting=NQPCORE --target=mbc --output $(JS_STAGE2_DIR)/sprintf.moarvm  src/HLL/sprintf.nqp > nqp-js-on-js/sprintf.js

js-stage1-compiler : $(JS_STAGE1_COMPILER)
js-test: js-all gen/js/qregex.t
	perl src/vm/js/bin/run_tests.pl
js-test-bootstrapped: js-bootstrap gen/js/qregex.t
	perl src/vm/js/bin/run_tests_bootstrapped.pl
gen/js/qregex.t: tools/build/process-qregex-tests
	$(JS_NQP) tools/build/process-qregex-tests > gen/js/qregex.t


js-clean:
	$(RM_RF) gen/js/stage1 gen/js/stage2

js-all : m-all js-stage1-compiler $(JS_STAGE2_DIR)/NQPCORE.setting.moarvm $(JS_STAGE2_DIR)/$(CORE_SETTING_COMBINED).nqp $(JS_STAGE2_DIR)/QASTNode.moarvm $(JS_STAGE2_DIR)/QRegex.moarvm $(JS_STAGE2_DIR)/sprintf.moarvm nqp-js-on-js/ModuleLoader.js
js-lint:
	gjslint --strict --max_line_length=200 --nojsdoc src/vm/js/nqp-runtime/*.js
js-install: js-all
	@echo "*** The JavaScript backend can't be installed yet, sorry! ***"
JS_NQP_SOURCES = $(COMMON_NQP_SOURCES)
$(JS_STAGE2_DIR)/$(NQP_COMBINED): $(JS_NQP_SOURCES)
	$(MKPATH) $(JS_STAGE2_DIR)
	$(PERL) tools/build/gen-version.pl > $(JS_STAGE2_DIR)/nqp-config.nqp
	$(PERL) tools/build/gen-cat.pl js $(JS_NQP_SOURCES) $(JS_STAGE2_DIR)/nqp-config.nqp > $(JS_STAGE2_DIR)/$(NQP_COMBINED)

JS_HLL_SOURCES = src/vm/js/HLL/Backend.nqp $(COMMON_HLL_SOURCES)
$(JS_STAGE2_DIR)/$(HLL_COMBINED): $(JS_HLL_SOURCES)
	$(MKPATH) $(JS_STAGE2_DIR)
	
	$(PERL) tools/build/gen-cat.pl js $(JS_HLL_SOURCES)  > $(JS_STAGE2_DIR)/$(HLL_COMBINED)

$(JS_STAGE2_DIR)/QAST/Compiler.moarvm: $(JS_STAGE1_COMPILER) $(JS_STAGE1_DIR)/QASTCompiler.nqp $(JS_STAGE2_DIR)/NQPCORE.setting.moarvm $(JS_STAGE2_DIR)/QASTNode.moarvm
	$(MKPATH) $(JS_STAGE2_DIR)/QAST
	$(MKPATH) nqp-js-on-js
	$(JS_NQP) --module-path gen/js/stage1 src/vm/js/bin/cross-compile.nqp --setting=NQPCORE --target=mbc --output $(JS_STAGE2_DIR)/QAST/Compiler.moarvm --no-regex-lib $(JS_STAGE1_DIR)/QASTCompiler.nqp > nqp-js-on-js/QAST-Compiler.js

$(JS_STAGE2_DIR)/QAST.moarvm: $(JS_STAGE1_COMPILER) src/vm/js/QAST.nqp $(JS_STAGE2_DIR)/NQPCORE.setting.moarvm $(JS_STAGE2_DIR)/QAST/Compiler.moarvm
	$(MKPATH) $(JS_STAGE2_DIR)
	$(MKPATH) nqp-js-on-js
	$(JS_NQP) --module-path gen/js/stage1 src/vm/js/bin/cross-compile.nqp --setting=NQPCORE --target=mbc --output $(JS_STAGE2_DIR)/QAST.moarvm --no-regex-lib src/vm/js/QAST.nqp > nqp-js-on-js/QAST.js

$(JS_STAGE2_DIR)/NQPHLL.moarvm: $(JS_STAGE1_COMPILER) $(JS_STAGE2_DIR)/$(HLL_COMBINED) $(JS_STAGE2_DIR)/NQPCORE.setting.moarvm $(JS_STAGE2_DIR)/QAST/Compiler.moarvm $(JS_STAGE2_DIR)/QRegex.moarvm
	$(MKPATH) $(JS_STAGE2_DIR)
	$(MKPATH) nqp-js-on-js
	$(JS_NQP) --module-path gen/js/stage1 src/vm/js/bin/cross-compile.nqp --setting=NQPCORE --target=mbc --output $(JS_STAGE2_DIR)/NQPHLL.moarvm --no-regex-lib $(JS_STAGE2_DIR)/$(HLL_COMBINED) > nqp-js-on-js/NQPHLL.js

$(JS_STAGE2_DIR)/$(P6QREGEX_COMBINED): $(P6QREGEX_SOURCES)
	$(MKPATH) $(JS_STAGE2_DIR)
	
	$(PERL) tools/build/gen-cat.pl js $(P6QREGEX_SOURCES)  > $(JS_STAGE2_DIR)/$(P6QREGEX_COMBINED)

$(JS_STAGE2_DIR)/$(P5QREGEX_COMBINED): $(P5QREGEX_SOURCES)
	$(MKPATH) $(JS_STAGE2_DIR)
	
	$(PERL) tools/build/gen-cat.pl js $(P5QREGEX_SOURCES)  > $(JS_STAGE2_DIR)/$(P5QREGEX_COMBINED)

$(JS_STAGE2_DIR)/NQPP5QRegex.moarvm: $(JS_STAGE1_COMPILER) $(JS_STAGE2_DIR)/$(P5QREGEX_COMBINED) $(JS_STAGE2_DIR)/NQPCORE.setting.moarvm $(JS_STAGE2_DIR)/QAST.moarvm $(JS_STAGE2_DIR)/NQPHLL.moarvm $(JS_STAGE2_DIR)/QRegex.moarvm
	$(MKPATH) $(JS_STAGE2_DIR)
	$(MKPATH) nqp-js-on-js
	$(JS_NQP) --module-path gen/js/stage1 src/vm/js/bin/cross-compile.nqp --setting=NQPCORE --target=mbc --output $(JS_STAGE2_DIR)/NQPP5QRegex.moarvm --no-regex-lib $(JS_STAGE2_DIR)/$(P5QREGEX_COMBINED) > nqp-js-on-js/NQPP5QRegex.js

$(JS_STAGE2_DIR)/NQPP6QRegex.moarvm: $(JS_STAGE1_COMPILER) $(JS_STAGE2_DIR)/$(P6QREGEX_COMBINED) $(JS_STAGE2_DIR)/NQPCORE.setting.moarvm $(JS_STAGE2_DIR)/QAST.moarvm $(JS_STAGE2_DIR)/NQPHLL.moarvm $(JS_STAGE2_DIR)/QRegex.moarvm
	$(MKPATH) $(JS_STAGE2_DIR)
	$(MKPATH) nqp-js-on-js
	$(JS_NQP) --module-path gen/js/stage1 src/vm/js/bin/cross-compile.nqp --setting=NQPCORE --target=mbc --output $(JS_STAGE2_DIR)/NQPP6QRegex.moarvm --no-regex-lib $(JS_STAGE2_DIR)/$(P6QREGEX_COMBINED) > nqp-js-on-js/NQPP6QRegex.js

nqp-js-on-js/ModuleLoader.js: $(JS_STAGE2_DIR)/NQPCORE.setting.moarvm src/vm/js/ModuleLoader.nqp $(JS_STAGE1_COMPILER)
	./nqp-js --setting=NULL --no-regex-lib --target=js --output nqp-js-on-js/ModuleLoader.js src/vm/js/ModuleLoader.nqp

nqp-js-on-js/nqp-bootstrapped.js: $(JS_STAGE2_DIR)/QAST.moarvm $(JS_STAGE2_DIR)/NQPP5QRegex.moarvm $(JS_STAGE2_DIR)/NQPP6QRegex.moarvm $(JS_STAGE2_DIR)/$(NQP_COMBINED) $(JS_STAGE2_DIR)/QRegex.moarvm
	./nqp-js --target=js --shebang $(JS_STAGE2_DIR)/$(NQP_COMBINED) > nqp-js-on-js/nqp-bootstrapped.js

js-bootstrap : js-all nqp-js-on-js/nqp-bootstrapped.js
